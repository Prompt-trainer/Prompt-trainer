{% extends 'base.html' %}


{% block title %}Чат з {{ other_user.nickname }}{% endblock %}


{% block content %}
<style>
    #chat-messages {
        height: 500px;
        overflow-y: auto;
        background-color: var(--bs-body-bg);
        scrollbar-color: #888 #f1f1f1;
        scrollbar-width: thin;
    }

    #chat-messages::-webkit-scrollbar {
        width: 8px;
    }
    #chat-messages::-webkit-scrollbar-track {
        background: #f1f1f1;
    }
    #chat-messages::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }
    #chat-messages::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    .message-bubble {
        max-width: 70%;
        word-wrap: break-word;
        margin-bottom: 10px;
        animation: fadeIn 0.3s;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* власні й чужі повідомлення під тему */
    .message-card-own {
        background-color: var(--bs-primary);
        color: #fff;
    }
    .message-card-other {
        background-color: var(--bs-tertiary-bg);
        color: var(--bs-body-color);
    }
</style>


<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <div>
                        <a href="{% url 'chat:conversations_list' %}" class="text-white me-3">
                            <i class="bi bi-arrow-left"></i>
                        </a>
                        <strong>{{ other_user.nickname }}</strong>
                    </div>
                    <span class="badge bg-light text-dark" id="online-status">
                        <i class="bi bi-circle-fill text-success"></i> Онлайн
                    </span>
                </div>
                <div class="card-body p-0">
                    <div id="chat-messages" class="p-3">
                        <div class="text-center text-muted">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Завантаження...</span>
                            </div>
                            <p class="mt-2">Завантаження повідомлень...</p>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="input-group">
                        <input 
                            type="text" 
                            id="message-input" 
                            class="form-control" 
                            placeholder="Введіть повідомлення..."
                            autocomplete="off"
                        >
                        <button id="send-button" class="btn btn-primary" type="button">
                            <i class="bi bi-send-fill"></i> Відправити
                        </button>
                    </div>
                    <small class="text-muted">Натисніть Enter для відправки</small>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    const userId = {{ request.user.id }};
    const otherUserId = {{ other_user.id }};
    const otherUserNickname = "{{ other_user.nickname }}";
    const currentUserNickname = "{{ request.user.nickname }}";
    
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const chatSocket = new WebSocket(
        protocol + '//' + window.location.host + '/ws/chat/private/' + otherUserId + '/'
    );

    const messagesDiv = document.getElementById('chat-messages');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');

    chatSocket.onopen = function(e) {
        console.log('WebSocket підключено');
        chatSocket.send(JSON.stringify({
            'type': 'mark_read'
        }));
    };

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        
        if (data.type === 'message_history') {
            messagesDiv.innerHTML = '';
            if (data.messages.length === 0) {
                messagesDiv.innerHTML = '<div class="text-center text-muted py-5"><i class="bi bi-chat"></i><p class="mt-2">Немає повідомлень. Почніть розмову!</p></div>';
            } else {
                data.messages.forEach(msg => {
                    appendMessage(msg);
                });
            }
        } else if (data.type === 'message') {
            appendMessage(data);
            chatSocket.send(JSON.stringify({
                'type': 'mark_read'
            }));
        }
        
        scrollToBottom();
    };

    chatSocket.onclose = function(e) {
        console.error('WebSocket закрито');
        messagesDiv.innerHTML += '<div class="alert alert-warning text-center mt-3">З\'єднання втрачено. Оновіть сторінку.</div>';
    };

    chatSocket.onerror = function(e) {
        console.error('WebSocket помилка:', e);
    };

    function appendMessage(msg) {
        const isOwn = msg.sender_id === userId;
        const messageDiv = document.createElement('div');
        messageDiv.className = `d-flex ${isOwn ? 'justify-content-end' : 'justify-content-start'} mb-3`;
        
        const time = new Date(msg.timestamp).toLocaleTimeString('uk-UA', {
            hour: '2-digit',
            minute: '2-digit'
        });
        
        messageDiv.innerHTML = `
            <div class="message-bubble">
                <div class="card ${isOwn ? 'message-card-own' : 'message-card-other'} border-0 shadow-sm">
                    <div class="card-body py-2 px-3">
                        ${!isOwn ? `<small class="fw-bold">${msg.sender}</small><br>` : ''}
                        <div>${escapeHtml(msg.message)}</div>
                        <small class="${isOwn ? 'text-white-50' : 'text-muted'}" style="font-size: 0.75rem;">
                            ${time}
                        </small>
                    </div>
                </div>
            </div>
        `;
        
        messagesDiv.appendChild(messageDiv);
    }

    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }

    function scrollToBottom() {
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function sendMessage() {
        const message = messageInput.value.trim();
        
        if (message && chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({
                'type': 'message',
                'message': message
            }));
            messageInput.value = '';
            messageInput.focus();
        }
    }

    sendButton.onclick = sendMessage;

    messageInput.onkeypress = function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            sendMessage();
        }
    };

    messageInput.focus();
</script>
{% endblock %}
