{% extends 'base.html' %}
{% load static %}

{% block title %}–ì–ª–æ–±–∞–ª—å–Ω–∏–π –ß–∞—Ç{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-10 offset-md-1 col-lg-8 offset-lg-2">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="bi bi-chat-dots"></i> –ì–ª–æ–±–∞–ª—å–Ω–∏–π –ß–∞—Ç
                            <span class="badge bg-light text-dark ms-2" id="online-count">
                                <i class="bi bi-people-fill"></i> Online
                            </span>
                        </h4>
                        <div class="btn-group" role="group">
                            <a href="{% url 'chat:conversations_list' %}" 
                               class="btn btn-light btn-sm" 
                               title="–ú–æ—ó —Ä–æ–∑–º–æ–≤–∏">
                                <i class="bi bi-chat-left-text"></i> –ü—Ä–∏–≤–∞—Ç–Ω—ñ —á–∞—Ç–∏
                            </a>
                            <a href="{% url 'chat:users_list' %}" 
                               class="btn btn-success btn-sm" 
                               title="–ü–æ—á–∞—Ç–∏ –Ω–æ–≤–∏–π —á–∞—Ç">
                                <i class="bi bi-plus-circle"></i> –ù–æ–≤–∏–π —á–∞—Ç
                            </a>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0" style="height: 500px; overflow-y: auto; background-color: var(--bs-body-bg);" id="chat-log">
                    <div class="text-center text-muted py-5">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span>
                        </div>
                        <p class="mt-2">–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ —á–∞—Ç—É...</p>
                    </div>
                </div>
                <div class="card-footer">
                    <form id="chat-form">
                        <div class="input-group">
                            <input type="text" 
                                id="chat-message-input" 
                                class="form-control" 
                                placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." 
                                autocomplete="off"
                                maxlength="1000"
                                required>
                            <button class="btn btn-primary" type="submit" id="send-button">
                                <i class="bi bi-send-fill"></i> –ù–∞–¥—ñ—Å–ª–∞—Ç–∏
                            </button>
                        </div>
                        <small class="text-muted">–ú–∞–∫—Å–∏–º—É–º 1000 —Å–∏–º–≤–æ–ª—ñ–≤ ‚Ä¢ –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å Enter –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏</small>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .message-bubble {
        max-width: 70%;
        word-wrap: break-word;
        animation: fadeIn 0.3s;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .message-own {
        background-color: var(--bs-primary) !important;
        color: white !important;
    }
    
    .message-other {
        background-color: var(--bs-secondary-bg);
        color: var(--bs-body-color);
    }
    
    .message-content {
        white-space: pre-wrap;
        word-break: break-word;
    }
    
    .username-link {
        cursor: pointer;
        text-decoration: none;
        transition: opacity 0.2s;
    }
    
    .username-link:hover {
        opacity: 0.8;
        text-decoration: underline;
    }
    
    #chat-log::-webkit-scrollbar {
        width: 8px;
    }
    
    #chat-log::-webkit-scrollbar-track {
        background: var(--bs-tertiary-bg);
    }
    
    #chat-log::-webkit-scrollbar-thumb {
        background: var(--bs-secondary);
        border-radius: 4px;
    }
</style>

<script>
    const currentUserId = {{request.user.id}};
    const currentUsername = "{{ request.user.nickname|escapejs }}";
    const chatLog = document.querySelector('#chat-log');
    const messageInput = document.querySelector('#chat-message-input');
    const chatForm = document.querySelector('#chat-form');
    const sendButton = document.querySelector('#send-button');
    
    function getWebSocketURL() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const host = window.location.host;
        return `${protocol}//${host}/ws/chat/`;
    }
    
    const chatSocket = new WebSocket(getWebSocketURL());
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    let reconnectTimeout;
    
    chatSocket.onopen = function(e) {
        console.log('‚úÖ WebSocket connection established:', getWebSocketURL());
        reconnectAttempts = 0;
        chatLog.innerHTML = '<div class="text-center text-muted py-3"><i class="bi bi-check-circle"></i> –ü—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–æ —á–∞—Ç—É</div>';
    };
    
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        
        if (data.type === 'message_history') {
            chatLog.innerHTML = '';
            if (data.messages.length === 0) {
                chatLog.innerHTML = '<div class="text-center text-muted py-5"><i class="bi bi-chat"></i><br>–ù–µ–º–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å. –ë—É–¥—å—Ç–µ –ø–µ—Ä—à–∏–º!</div>';
            } else {
                data.messages.forEach(msg => appendMessage(msg));
            }
            scrollToBottom();
        } else if (data.type === 'chat_message') {
            appendMessage(data);
            scrollToBottom();
        }
    };
    
    chatSocket.onclose = function(e) {
        console.error('‚ùå Chat socket closed:', e.code, e.reason);
        chatLog.innerHTML = '<div class="alert alert-danger m-3"><i class="bi bi-exclamation-triangle"></i> –í—Ç—Ä–∞—á–µ–Ω–æ –∑\'—î–¥–Ω–∞–Ω–Ω—è –∑ —á–∞—Ç–æ–º.</div>';
        
        if (reconnectAttempts < maxReconnectAttempts) {
            reconnectAttempts++;
            const delay = Math.min(1000 * Math.pow(2, reconnectAttempts - 1), 30000);
            console.log(`üîÑ –°–ø—Ä–æ–±–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—è ${reconnectAttempts}/${maxReconnectAttempts} —á–µ—Ä–µ–∑ ${delay}ms`);
            
            reconnectTimeout = setTimeout(() => {
                location.reload();
            }, delay);
        } else {
            chatLog.innerHTML += '<div class="alert alert-warning mt-3"><button class="btn btn-sm btn-primary" onclick="location.reload()">–û–Ω–æ–≤–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É</button></div>';
        }
    };
    
    chatSocket.onerror = function(e) {
        console.error('‚ö†Ô∏è WebSocket error:', e);
        if (chatSocket.readyState === WebSocket.CLOSED) {
            chatLog.innerHTML = '<div class="alert alert-danger m-3"><i class="bi bi-wifi-off"></i> –ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12).</div>';
        }
    };
    
    chatForm.onsubmit = function(e) {
        e.preventDefault();
        const message = messageInput.value.trim();
        
        if (message && chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({
                'type': 'chat_message',
                'message': message
            }));
            messageInput.value = '';
            messageInput.focus();
        }
    };
    
    function appendMessage(data) {
        const messageDiv = document.createElement('div');
        const isOwn = data.user_id === currentUserId;
        
        messageDiv.className = `mb-3 px-3 ${isOwn ? 'text-end' : 'text-start'}`;
        
        const timestamp = new Date(data.timestamp).toLocaleTimeString('uk-UA', {
            hour: '2-digit',
            minute: '2-digit'
        });
        
        const bubbleClass = isOwn ? 'message-own' : 'message-other';
        
        const usernameHtml = isOwn 
            ? `<strong class="me-2">${escapeHtml(data.username)}</strong>`
            : `<a href="/chat/private/${data.user_id}/" class="username-link text-decoration-none me-2" title="–í—ñ–¥–∫—Ä–∏—Ç–∏ –ø—Ä–∏–≤–∞—Ç–Ω–∏–π —á–∞—Ç">
                 <strong>${escapeHtml(data.username)}</strong>
               </a>`;
        
        messageDiv.innerHTML = `
            <div class="d-inline-block ${bubbleClass} message-bubble rounded-3 px-3 py-2 shadow-sm">
                <div class="d-flex align-items-center mb-1">
                    ${usernameHtml}
                    <small class="opacity-75">${timestamp}</small>
                </div>
                <div class="message-content">${escapeHtml(data.message)}</div>
            </div>
        `;
        
        chatLog.appendChild(messageDiv);
    }
    
    function scrollToBottom() {
        chatLog.scrollTop = chatLog.scrollHeight;
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    messageInput.focus();
</script>
{% endblock %}
